<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <title>Messenger Generator - Auto Import</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: #f5f5f5;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #1877f2;
            margin-bottom: 10px;
        }

        .import-section {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .import-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
        }

        .file-input {
            position: absolute;
            left: -9999px;
        }

        .file-input-label {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            background: #1877f2;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
        }

        .file-input-label:hover {
            background: #166fe5;
        }

        .sample-section {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #1877f2;
        }

        .sample-section h4 {
            margin-top: 0;
            color: #333;
        }

        .sample-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 12px;
        }

        .sample-table th,
        .sample-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        .sample-table th {
            background: #1877f2;
            color: white;
            font-weight: 600;
        }

        .controls {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .control-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: #1877f2;
            color: white;
        }

        .btn-primary:hover {
            background: #166fe5;
        }

        .btn-success {
            background: #42b883;
            color: white;
        }

        .btn-success:hover {
            background: #369870;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-download {
            background: #f39c12;
            color: white;
            font-size: 16px;
            padding: 12px 24px;
        }

        .btn-download:hover {
            background: #e67e22;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .stat-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            flex: 1;
            min-width: 120px;
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #1877f2;
        }

        .stat-label {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }

        .screens-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .screen-wrapper {
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .screen-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .screen-title {
            font-weight: 600;
            color: #333;
            flex: 1;
        }

        .screen-actions {
            display: flex;
            gap: 5px;
        }

        .screen-checkbox {
            margin-right: 10px;
        }

        .delete-screen,
        .download-single {
            border: none;
            border-radius: 6px;
            padding: 5px 8px;
            cursor: pointer;
            font-size: 12px;
        }

        .delete-screen {
            background: #e74c3c;
            color: white;
        }

        .download-single {
            background: #f39c12;
            color: white;
        }

        /* Messenger Styles */
        .messenger {
            width: 360px;
            margin: 0 auto;
            background: #fff;
            height: 600px;
            display: flex;
            flex-direction: column;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border: 1px solid #e4e6eb;
            overflow: hidden;
            position: relative;
        }

        .messenger-header {
            display: flex;
            align-items: center;
            padding: 10px 12px 6px 8px;
            background: #fff;
            border-bottom: 1px solid #f0f2f5;
            min-height: 56px;
            flex-shrink: 0;
        }

        .back-btn {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: none;
            border: none;
            margin-right: 2px;
            font-size: 22px;
            color: #1877f2;
            cursor: pointer;
        }

        .badge {
            background: #1877f2;
            color: #fff;
            font-size: 15px;
            font-weight: 600;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 8px;
            margin-left: -6px;
            margin-bottom: 2px;
            border: 2px solid #fff;
        }

        .avatar-wrapper {
            position: relative;
            display: inline-block;
            width: 38px;
            height: 38px;
            margin-right: 10px;
        }

        .avatar {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            object-fit: cover;
            border: none;
        }

        .avatar-status {
            position: absolute;
            width: 7px;
            height: 7px;
            background: #31a24c;
            border: 2px solid #fff;
            border-radius: 50%;
            bottom: -1px;
            right: -1px;
            z-index: 2;
            box-sizing: content-box;
        }

        .messenger-header-info {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-width: 0;
        }

        .name {
            font-weight: 600;
            font-size: 16px;
            color: #050505;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .status {
            font-size: 13px;
            color: #65676b;
            margin-top: 1px;
        }

        .header-actions {
            display: flex;
            gap: 8px;
            margin-left: auto;
        }

        .header-action {
            width: 36px;
            height: 36px;
            background: #ffffff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #1877f2;
            font-size: 18px;
            cursor: pointer;
            border: none;
        }

        .message-container {
            flex: 1;
            overflow-y: auto;
            background: #fff;
            padding: 0 0 10px 0;
            display: flex;
            flex-direction: column;
        }

        .time-label {
            text-align: center;
            color: #65676b;
            font-size: 13px;
            margin: 18px 0 10px 0;
            font-weight: 400;
        }

        .msg-row {
            display: flex;
            align-items: flex-end;
            margin-bottom: 2px;
            padding: 0 10px;
        }

        .msg-row.me {
            flex-direction: row-reverse;
        }

        .msg-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            object-fit: cover;
            margin: 0 6px 2px 0;
        }

        .msg-row.me .msg-avatar {
            margin: 0 0 2px 6px;
        }

        .bubble {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 20px;
            font-size: 15px;
            line-height: 1.4;
            margin-bottom: 4px;
            word-break: break-word;
            position: relative;
        }

        .msg-row.me .bubble {
            background: #1877f2;
            color: #fff;
            border-bottom-right-radius: 6px;
        }

        .msg-row.other .bubble {
            background: #f0f2f5;
            color: #050505;
            border-bottom-left-radius: 6px;
        }

        /* Image message styles */
        .message-image {
            max-width: 100%;
            width: auto;
            height: auto;
            max-height: 300px;
            border-radius: 12px;
            display: block;
            margin: 0;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .message-image:hover {
            opacity: 0.9;
        }

        .bubble:has(.message-image) {
            padding: 4px;
            background: transparent !important;
        }

        /* Fallback for browsers that don't support :has() */
        .bubble.image-bubble {
            padding: 4px;
            background: transparent !important;
        }

        .sent-label {
            font-size: 13px;
            color: #b0b3b8;
            margin-right: 10px;
            margin-top: 2px;
            text-align: right;
        }

        .input-container {
            display: flex;
            align-items: center;
            padding: 8px 8px;
            background: #fff;
            border-top: 1px solid #f0f2f5;
            gap: 6px;
            min-height: 56px;
            flex-shrink: 0;
        }

        .input-btn {
            width: 28px;
            height: 28px;
            background: #ffffff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #1877f2;
            font-size: 16px;
            border: none;
            cursor: pointer;
            flex-shrink: 0;
        }

        .input-box {
            flex: 1;
            background: #f0f2f5;
            border: none;
            border-radius: 20px;
            padding: 8px 15px;
            font-size: 15px;
            outline: none;
            margin: 0 4px;
            min-width: 80px;
            min-height: 20px;
            width: auto;
        }

        .download-section {
            text-align: center;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .download-options {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .loading {
            display: none;
            color: #1877f2;
            margin-top: 10px;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
            display: none;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
            display: none;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1><i class="fab fa-facebook-messenger"></i> Messenger Generator Pro</h1>
            <p>Import file Excel/CSV ƒë·ªÉ t·ª± ƒë·ªông t·∫°o h√†ng lo·∫°t m√†n h√¨nh Messenger</p>
        </div>

        <!-- Import Section -->
        <div class="import-section">
            <div class="import-header">
                <h3><i class="fas fa-file-import"></i> Import d·ªØ li·ªáu t·ª´ file</h3>
                <div class="file-input-wrapper">
                    <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls,.csv" />
                    <label for="fileInput" class="file-input-label">
                        <i class="fas fa-upload"></i>
                        Ch·ªçn file Excel/CSV
                    </label>
                </div>
            </div>

            <div class="sample-section">
                <h4><i class="fas fa-table"></i> C·∫•u tr√∫c file c·∫ßn thi·∫øt:</h4>
                <p><strong>File ph·∫£i c√≥ c√°c c·ªôt sau (th·ª© t·ª± kh√¥ng quan tr·ªçng):</strong></p>
                <table class="sample-table">
                    <thead>
                        <tr>
                            <th>screen_id</th>
                            <th>contact_name</th>
                            <th>avatar_url</th>
                            <th>user_status</th>
                            <th>message_text</th>
                            <th>sender</th>
                            <th>time_display</th>
                            <th>show_time</th>
                            <th>message_type</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>1</td>
                            <td>Nguyen Giang</td>
                            <td>https://example.com/avatar.jpg</td>
                            <td>ƒêang ho·∫°t ƒë·ªông</td>
                            <td>Ch√†o b·∫°n!</td>
                            <td>other</td>
                            <td>14:30</td>
                            <td>TRUE</td>
                            <td>text</td>
                        </tr>
                        <tr>
                            <td>1</td>
                            <td>Nguyen Giang</td>
                            <td>https://example.com/avatar.jpg</td>
                            <td>ƒêang ho·∫°t ƒë·ªông</td>
                            <td>https://example.com/photo.jpg</td>
                            <td>me</td>
                            <td></td>
                            <td>FALSE</td>
                            <td>image</td>
                        </tr>
                        <tr>
                            <td>2</td>
                            <td>Mai Anh</td>
                            <td>https://example.com/avatar2.jpg</td>
                            <td>Ho·∫°t ƒë·ªông 5 ph√∫t tr∆∞·ªõc</td>
                            <td>H·∫πn g·∫∑p l·∫°i nh√©</td>
                            <td>me</td>
                            <td>15:45</td>
                            <td>TRUE</td>
                            <td>text</td>
                        </tr>
                    </tbody>
                </table>

                <div style="margin-top: 15px;">
                    <p><strong>Gi·∫£i th√≠ch c√°c c·ªôt:</strong></p>
                    <ul style="text-align: left; font-size: 13px;">
                        <li><strong>screen_id:</strong> ‚≠ê B·∫ÆT BU·ªòC - ID m√†n h√¨nh (c√°c d√≤ng c√πng ID s·∫Ω thu·ªôc 1 m√†n h√¨nh)</li>
                        <li><strong>contact_name:</strong> ‚≠ê B·∫ÆT BU·ªòC - T√™n ng∆∞·ªùi chat</li>
                        <li><strong>avatar_url:</strong> üîß T√ôY CH·ªåN - Link ·∫£nh avatar (ƒë·ªÉ tr·ªëng s·∫Ω d√πng avatar ƒë·∫πp m·∫∑c ƒë·ªãnh)</li>
                        <li><strong>user_status:</strong> üîß T√ôY CH·ªåN - Tr·∫°ng th√°i (ƒêang ho·∫°t ƒë·ªông, Ho·∫°t ƒë·ªông 5 ph√∫t tr∆∞·ªõc, v.v.)</li>
                        <li><strong>message_text:</strong> ‚≠ê B·∫ÆT BU·ªòC - N·ªôi dung tin nh·∫Øn HO·∫∂C link ·∫£nh</li>
                        <li><strong>sender:</strong> ‚≠ê B·∫ÆT BU·ªòC - me (tin nh·∫Øn c·ªßa t√¥i) ho·∫∑c other (tin nh·∫Øn c·ªßa ng∆∞·ªùi kia)</li>
                        <li><strong>time_display:</strong> üîß T√ôY CH·ªåN - Th·ªùi gian hi·ªÉn th·ªã (VD: 14:30, 12 THG 7)</li>
                        <li><strong>show_time:</strong> üîß T√ôY CH·ªåN - TRUE/FALSE - c√≥ hi·ªÉn th·ªã th·ªùi gian kh√¥ng</li>
                        <li><strong>message_type:</strong> üÜï M·ªöI - "text" (m·∫∑c ƒë·ªãnh) ho·∫∑c "image" (ƒë·ªÉ g·ª≠i ·∫£nh)</li>
                    </ul>
                    <p style="color: #1877f2; font-weight: 600; margin-top: 10px;">
                        üí° M·∫πo: Ch·ªâ c·∫ßn 4 c·ªôt B·∫ÆT BU·ªòC c√≥ ‚≠ê, c√°c c·ªôt kh√°c c√≥ th·ªÉ ƒë·ªÉ tr·ªëng!
                    </p>
                    <p style="color: #e74c3c; font-weight: 600; margin-top: 8px;">
                        üì∏ G·ª¨I ·∫¢NH: ƒê·∫∑t message_type = "image" v√† ƒëi·ªÅn URL ·∫£nh v√†o message_text
                    </p>
                </div>

                <button class="btn btn-secondary" onclick="downloadSampleFile()">
                    <i class="fas fa-download"></i> T·∫£i file m·∫´u Excel
                </button>
            </div>

            <div class="error-message" id="errorMessage"></div>
            <div class="success-message" id="successMessage"></div>
        </div>

        <!-- Stats -->
        <div class="stats" id="stats" style="display: none;">
            <div class="stat-item">
                <div class="stat-number" id="totalScreens">0</div>
                <div class="stat-label">M√†n h√¨nh</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="totalMessages">0</div>
                <div class="stat-label">Tin nh·∫Øn</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="selectedScreens">0</div>
                <div class="stat-label">ƒê√£ ch·ªçn</div>
            </div>
        </div>

        <!-- Controls -->
        <div class="controls" id="controlsSection" style="display: none;">
            <div class="control-row">
                <button class="btn btn-primary" onclick="selectAllScreens()">
                    <i class="fas fa-check-square"></i> Ch·ªçn t·∫•t c·∫£
                </button>
                <button class="btn btn-secondary" onclick="deselectAllScreens()">
                    <i class="fas fa-square"></i> B·ªè ch·ªçn t·∫•t c·∫£
                </button>
                <button class="btn btn-danger" onclick="clearAll()">
                    <i class="fas fa-trash"></i> X√≥a t·∫•t c·∫£
                </button>
            </div>
        </div>

        <!-- Screens Grid -->
        <div class="screens-grid" id="screensGrid">
            <!-- Screens will be generated here -->
        </div>

        <!-- Download Section -->
        <div class="download-section" id="downloadSection" style="display: none;">
            <div class="download-options">
                <button class="btn btn-download" onclick="downloadSelectedScreens()">
                    <i class="fas fa-download"></i> Download m√†n h√¨nh ƒë√£ ch·ªçn (t·ª´ng file)
                </button>
                <button class="btn btn-download" onclick="downloadAllScreens()">
                    <i class="fas fa-download"></i> Download t·∫•t c·∫£ (t·ª´ng file)
                </button>
            </div>
            <div class="loading" id="loading">
                <i class="fas fa-spinner fa-spin"></i> ƒêang t·∫°o file...
            </div>
        </div>
    </div>

    <script>
        let screens = [];
        let selectedScreens = new Set();

        // File input handler
        document.getElementById('fileInput').addEventListener('change', handleFileUpload);

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    let data;

                    if (file.name.endsWith('.csv')) {
                        data = parseCSV(e.target.result);
                    } else {
                        const workbook = XLSX.read(e.target.result, { 
                            type: 'binary',
                            cellDates: true,
                            cellStyles: false
                        });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        
                        data = XLSX.utils.sheet_to_json(worksheet, {
                            raw: false,
                            defval: '',
                            blankrows: false
                        });
                    }

                    if (data.length === 0) {
                        throw new Error('File kh√¥ng c√≥ d·ªØ li·ªáu ho·∫∑c ƒë·ªãnh d·∫°ng kh√¥ng ƒë√∫ng');
                    }

                    processImportedData(data);
                    showSuccess(`ƒê√£ import th√†nh c√¥ng ${data.length} d√≤ng d·ªØ li·ªáu!`);

                } catch (error) {
                    console.error('Import error:', error);
                    showError('L·ªói ƒë·ªçc file: ' + error.message);
                }
            };

            if (file.name.endsWith('.csv')) {
                reader.readAsText(file);
            } else {
                reader.readAsBinaryString(file);
            }
        }

        function parseCSV(text) {
            const lines = text.split('\n');
            const headers = lines[0].split(',').map(h => h.trim());
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim()) {
                    const values = lines[i].split(',');
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = values[index] ? values[index].trim() : '';
                    });
                    data.push(row);
                }
            }

            return data;
        }

        function processImportedData(data) {
            const screenMap = new Map();

            // Ki·ªÉm tra data c√≥ t·ªìn t·∫°i kh√¥ng
            if (!data || data.length === 0) {
                throw new Error('File kh√¥ng c√≥ d·ªØ li·ªáu');
            }
            
            const firstRow = data[0];
            console.log('DEBUG - First row:', firstRow);
            console.log('DEBUG - Available columns:', Object.keys(firstRow));
            
            // CH·ªà validate c√°c c·ªôt th·ª±c s·ª± b·∫Øt bu·ªôc
            const requiredColumns = ['screen_id', 'contact_name', 'message_text', 'sender'];
            const availableColumns = Object.keys(firstRow);
            const missingColumns = requiredColumns.filter(col => !availableColumns.includes(col));
            
            if (missingColumns.length > 0) {
                throw new Error(`Thi·∫øu c√°c c·ªôt b·∫Øt bu·ªôc: ${missingColumns.join(', ')}\nC√°c c·ªôt hi·ªán c√≥: ${availableColumns.join(', ')}`);
            }
            
            console.log('‚úÖ Validation passed - All required columns found');
            
            // Danh s√°ch avatar m·∫∑c ƒë·ªãnh ƒë·∫πp
            const defaultAvatars = [
                'https://images.unsplash.com/photo-1494790108755-2616b612b665?w=150&h=150&fit=crop&crop=face',
                'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=150&h=150&fit=crop&crop=face',
                'https://images.unsplash.com/photo-1438761681033-6461ffad8d80?w=150&h=150&fit=crop&crop=face',
                'https://images.unsplash.com/photo-1544725176-7c40e5a71c5e?w=150&h=150&fit=crop&crop=face',
                'https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=150&h=150&fit=crop&crop=face'
            ];

            // Group data by screen_id
            data.forEach(row => {
                const screenId = row.screen_id;
                if (!screenMap.has(screenId)) {
                    // X·ª≠ l√Ω avatar_url - KH√îNG validation, ch·ªâ s·ª≠ d·ª•ng
                    let avatarUrl = row.avatar_url || row['avatar_url'] || row.avatarUrl;
                    
                    // Ki·ªÉm tra n·∫øu avatar_url l√† r·ªóng ho·∫∑c kh√¥ng h·ª£p l·ªá
                    if (!avatarUrl || avatarUrl.trim() === '' || avatarUrl === '""' || avatarUrl === "''") {
                        // Ch·ªçn avatar m·∫∑c ƒë·ªãnh d·ª±a tr√™n screen_id
                        const avatarIndex = (screenId - 1) % defaultAvatars.length;
                        avatarUrl = defaultAvatars[avatarIndex];
                        console.log(`üì∑ Screen ${screenId}: S·ª≠ d·ª•ng avatar m·∫∑c ƒë·ªãnh`);
                    } else {
                        console.log(`üì∑ Screen ${screenId}: S·ª≠ d·ª•ng avatar t·ª´ file (${avatarUrl.length} chars)`);
                    }

                    screenMap.set(screenId, {
                        id: screenId,
                        contactName: (row.contact_name || 'Unknown').trim(),
                        avatarUrl: avatarUrl,
                        userStatus: row.user_status || 'ƒêang ho·∫°t ƒë·ªông',
                        messages: []
                    });
                }

                const screen = screenMap.get(screenId);
                screen.messages.push({
                    id: Date.now() + Math.random(),
                    text: row.message_text || '',
                    sender: (row.sender === 'me' || row.sender === 'ME') ? 'me' : 'other',
                    time: row.time_display || '',
                    showTime: row.show_time === 'TRUE' || row.show_time === true || row.show_time === 'true' || row.show_time === 1,
                    type: row.message_type || 'text' // Th√™m type cho message
                });
            });

            // Convert to array and sort
            screens = Array.from(screenMap.values()).sort((a, b) => a.id - b.id);
            selectedScreens.clear();
            
            console.log(`‚úÖ ƒê√£ x·ª≠ l√Ω ${screens.length} m√†n h√¨nh th√†nh c√¥ng!`);

            renderScreens();
            updateStats();
            showSections();
        }

        function showSections() {
            document.getElementById('stats').style.display = 'flex';
            document.getElementById('controlsSection').style.display = 'block';
            document.getElementById('downloadSection').style.display = 'block';
        }

        function updateStats() {
            const totalMessages = screens.reduce((sum, screen) => sum + screen.messages.length, 0);
            document.getElementById('totalScreens').textContent = screens.length;
            document.getElementById('totalMessages').textContent = totalMessages;
            document.getElementById('selectedScreens').textContent = selectedScreens.size;
        }

        function selectAllScreens() {
            selectedScreens.clear();
            screens.forEach(screen => selectedScreens.add(screen.id));
            updateCheckboxes();
            updateStats();
        }

        function deselectAllScreens() {
            selectedScreens.clear();
            updateCheckboxes();
            updateStats();
        }

        function updateCheckboxes() {
            screens.forEach(screen => {
                const checkbox = document.getElementById(`checkbox-${screen.id}`);
                if (checkbox) {
                    checkbox.checked = selectedScreens.has(screen.id);
                }
            });
        }

        function toggleScreenSelection(screenId) {
            if (selectedScreens.has(screenId)) {
                selectedScreens.delete(screenId);
            } else {
                selectedScreens.add(screenId);
            }
            updateStats();
        }

        function deleteScreen(screenId) {
            screens = screens.filter(screen => screen.id != screenId);
            selectedScreens.delete(screenId);
            renderScreens();
            updateStats();
        }

        function clearAll() {
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a t·∫•t c·∫£ m√†n h√¨nh?')) {
                screens = [];
                selectedScreens.clear();
                renderScreens();
                updateStats();
                document.getElementById('stats').style.display = 'none';
                document.getElementById('controlsSection').style.display = 'none';
                document.getElementById('downloadSection').style.display = 'none';
            }
        }

        function renderScreens() {
            const grid = document.getElementById('screensGrid');
            grid.innerHTML = '';

            screens.forEach(screen => {
                const screenWrapper = document.createElement('div');
                screenWrapper.className = 'screen-wrapper';
                screenWrapper.innerHTML = `
          <div class="screen-header">
            <div style="display: flex; align-items: center;">
              <input type="checkbox" class="screen-checkbox" id="checkbox-${screen.id}" 
                     onchange="toggleScreenSelection('${screen.id}')" 
                     ${selectedScreens.has(screen.id) ? 'checked' : ''}>
              <span class="screen-title">M√†n h√¨nh ${screen.id} - ${screen.contactName}</span>
            </div>
            <div class="screen-actions">
              <button class="download-single" onclick="downloadSingleScreen('${screen.id}')">
                <i class="fas fa-download"></i>
              </button>
              <button class="delete-screen" onclick="deleteScreen('${screen.id}')">
                <i class="fas fa-times"></i>
              </button>
            </div>
          </div>
          <div class="messenger" id="screen-${screen.id}">
            <div class="messenger-header">
              <button class="back-btn"><i class="fas fa-chevron-left"></i></button>
              <span class="badge">9</span>
              <div class="avatar-wrapper">
                <img src="${screen.avatarUrl}" class="avatar" alt="Avatar" onerror="this.src='https://th.bing.com/th/id/OIP.IlrrnM9UiiG5HFqcixNYoAHaHa?cb=iwc2&rs=1&pid=ImgDetMain'">
                <div class="avatar-status"></div>
              </div>
              <div class="messenger-header-info">
                <span class="name">${screen.contactName}</span>
                <span class="status">${screen.userStatus}</span>
              </div>
              <div class="header-actions">
                <button class="header-action"><i class="fas fa-phone"></i></button>
                <button class="header-action"><i class="fas fa-video"></i></button>
              </div>
            </div>
            <div class="message-container">
              ${renderMessages(screen.messages, screen.avatarUrl)}
            </div>
            <div class="input-container">
              <button class="input-btn"><i class="fas fa-plus"></i></button>
              <button class="input-btn"><i class="fas fa-camera"></i></button>
              <button class="input-btn"><i class="far fa-image"></i></button>
              <button class="input-btn"><i class="fas fa-microphone"></i></button>
              <input type="text" class="input-box" placeholder="Aa">
              <button class="input-btn"><i class="far fa-smile"></i></button>
              <button class="input-btn"><i class="fas fa-thumbs-up"></i></button>
            </div>
          </div>
        `;
                grid.appendChild(screenWrapper);
            });
        }

        function renderMessages(messages, avatarUrl) {
            let html = '';
            let lastTime = '';

            messages.forEach((message, index) => {
                if (message.showTime && message.time !== lastTime) {
                    html += `<div class="time-label">${message.time}</div>`;
                    lastTime = message.time;
                }

                html += `
          <div class="msg-row ${message.sender}">
            ${message.sender === 'other' ? `<img src="${avatarUrl}" class="msg-avatar" alt="Avatar" onerror="this.src='https://th.bing.com/th/id/OIP.IlrrnM9UiiG5HFqcixNYoAHaHa?cb=iwc2&rs=1&pid=ImgDetMain'">` : ''}
            <div class="bubble ${message.type === 'image' ? 'image-bubble' : ''}">
              ${message.type === 'image' ? 
                `<img src="${message.text}" alt="Shared image" class="message-image" onerror="this.style.display='none'; this.parentNode.innerHTML='‚ùå Kh√¥ng th·ªÉ t·∫£i ·∫£nh';" />` : 
                message.text
              }
            </div>
          </div>
        `;

                // Add "ƒê√£ g·ª≠i" for last message from me
                if (index === messages.length - 1 && message.sender === 'me') {
                    html += `<div class="sent-label">ƒê√£ g·ª≠i</div>`;
                }
            });

            return html;
        }

        async function downloadSingleScreen(screenId) {
            const screen = screens.find(s => s.id == screenId);
            if (!screen) return;

            const loading = document.getElementById('loading');
            loading.style.display = 'block';

            try {
                const element = document.getElementById(`screen-${screenId}`);
                const canvas = await html2canvas(element, {
                    backgroundColor: '#ffffff',
                    scale: 2,
                    useCORS: true,
                    allowTaint: true,
                    foreignObjectRendering: true,
                    logging: false,
                    removeContainer: true
                });

                canvas.toBlob(blob => {
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = `messenger-screen-${screenId}-${screen.contactName.replace(/[^a-zA-Z0-9]/g, '_')}.png`;
                    link.click();
                    URL.revokeObjectURL(link.href);
                }, 'image/png');

            } catch (error) {
                console.error('Error generating screenshot:', error);
                showError('C√≥ l·ªói x·∫£y ra khi t·∫°o ·∫£nh. Vui l√≤ng th·ª≠ l·∫°i!');
            } finally {
                loading.style.display = 'none';
            }
        }

        async function downloadSelectedScreens() {
            if (selectedScreens.size === 0) {
                showError('Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 m√†n h√¨nh ƒë·ªÉ download!');
                return;
            }

            await downloadScreensIndividually(Array.from(selectedScreens));
        }

        async function downloadAllScreens() {
            if (screens.length === 0) {
                showError('Kh√¥ng c√≥ m√†n h√¨nh n√†o ƒë·ªÉ download!');
                return;
            }

            const allScreenIds = screens.map(screen => screen.id);
            await downloadScreensIndividually(allScreenIds);
        }

        async function downloadScreensIndividually(screenIds) {
            const loading = document.getElementById('loading');
            loading.style.display = 'block';

            try {
                let successCount = 0;
                let totalCount = screenIds.length;

                for (let i = 0; i < screenIds.length; i++) {
                    const screenId = screenIds[i];
                    const screen = screens.find(s => s.id == screenId);
                    const element = document.getElementById(`screen-${screenId}`);

                    try {
                        const canvas = await html2canvas(element, {
                            backgroundColor: '#ffffff',
                            scale: 2,
                            useCORS: true,
                            allowTaint: true,
                            foreignObjectRendering: true,
                            logging: false,
                            removeContainer: true
                        });

                        // T·∫°o v√† download t·ª´ng file ri√™ng l·∫ª
                        await new Promise((resolve) => {
                            canvas.toBlob(blob => {
                                const link = document.createElement('a');
                                link.href = URL.createObjectURL(blob);
                                link.download = `${String(screenId).padStart(3, '0')}-${screen.contactName.replace(/[^a-zA-Z0-9]/g, '_')}.png`;
                                
                                // Trigger download
                                document.body.appendChild(link);
                                link.click();
                                document.body.removeChild(link);
                                
                                // Cleanup
                                URL.revokeObjectURL(link.href);
                                successCount++;
                                resolve();
                            }, 'image/png');
                        });

                        // Delay nh·ªè gi·ªØa c√°c download ƒë·ªÉ tr√°nh spam browser
                        if (i < screenIds.length - 1) {
                            await new Promise(resolve => setTimeout(resolve, 500));
                        }

                    } catch (error) {
                        console.error(`Error downloading screen ${screenId}:`, error);
                    }
                }

                if (successCount === totalCount) {
                    showSuccess(`ƒê√£ t·∫£i th√†nh c√¥ng ${successCount} ·∫£nh m√†n h√¨nh!`);
                } else {
                    showError(`Ch·ªâ t·∫£i ƒë∆∞·ª£c ${successCount}/${totalCount} ·∫£nh. M·ªôt s·ªë ·∫£nh c√≥ l·ªói.`);
                }

            } catch (error) {
                console.error('Error downloading screens:', error);
                showError('C√≥ l·ªói x·∫£y ra khi t·∫£i ·∫£nh. Vui l√≤ng th·ª≠ l·∫°i!');
            } finally {
                loading.style.display = 'none';
            }
        }

        function downloadSampleFile() {
            const sampleData = [
                {
                    screen_id: 1,
                    contact_name: "Nguyen Giang",
                    avatar_url: "https://images.unsplash.com/photo-1494790108755-2616b612b665?w=150&h=150&fit=crop&crop=face",
                    user_status: "ƒêang ho·∫°t ƒë·ªông",
                    message_text: "Ch·ªã l∆∞u √Ω gi√∫p em ƒëi·ªán tho·∫°i, em g·ª≠i ship ho√° t·ªëc trong ng√†y l√† ch·ªã nh·∫≠n ƒë∆∞·ª£c nh√© ·∫°",
                    sender: "me",
                    time_display: "11:41, 12 THG 7",
                    show_time: "TRUE",
                    message_type: "text"
                },
                {
                    screen_id: 1,
                    contact_name: "Nguyen Giang",
                    avatar_url: "https://images.unsplash.com/photo-1494790108755-2616b612b665?w=150&h=150&fit=crop&crop=face",
                    user_status: "ƒêang ho·∫°t ƒë·ªông",
                    message_text: "Ok em",
                    sender: "other",
                    time_display: "",
                    show_time: "FALSE",
                    message_type: "text"
                },
                {
                    screen_id: 1,
                    contact_name: "Nguyen Giang",
                    avatar_url: "https://images.unsplash.com/photo-1494790108755-2616b612b665?w=150&h=150&fit=crop&crop=face",
                    user_status: "ƒêang ho·∫°t ƒë·ªông",
                    message_text: "https://images.unsplash.com/photo-1549388604-817d15aa0110?w=400&h=300&fit=crop",
                    sender: "me",
                    time_display: "",
                    show_time: "FALSE",
                    message_type: "image"
                },
                {
                    screen_id: 1,
                    contact_name: "Nguyen Giang",
                    avatar_url: "https://images.unsplash.com/photo-1494790108755-2616b612b665?w=150&h=150&fit=crop&crop=face",
                    user_status: "ƒêang ho·∫°t ƒë·ªông",
                    message_text: "C√¥ng nh·∫≠n v√≤ng n√†y h√∫t duy√™n th·∫≠t s·ª±",
                    sender: "me",
                    time_display: "13:04",
                    show_time: "TRUE",
                    message_type: "text"
                },
                {
                    screen_id: 1,
                    contact_name: "Nguyen Giang",
                    avatar_url: "https://images.unsplash.com/photo-1494790108755-2616b612b665?w=150&h=150&fit=crop&crop=face",
                    user_status: "ƒêang ho·∫°t ƒë·ªông",
                    message_text: "Ch·ªã l√†m tuy·ªÉn d·ª•ng",
                    sender: "me",
                    time_display: "",
                    show_time: "FALSE",
                    message_type: "text"
                },
                {
                    screen_id: 1,
                    contact_name: "Nguyen Giang",
                    avatar_url: "https://images.unsplash.com/photo-1494790108755-2616b612b665?w=150&h=150&fit=crop&crop=face",
                    user_status: "ƒêang ho·∫°t ƒë·ªông",
                    message_text: "th√°ng tr∆∞·ªõc ko ƒë·∫°t KPI, b·ªã s·∫øp m·∫Øng",
                    sender: "me",
                    time_display: "",
                    show_time: "FALSE",
                    message_type: "text"
                },
                {
                    screen_id: 2,
                    contact_name: "Mai Anh",
                    avatar_url: "https://images.unsplash.com/photo-1438761681033-6461ffad8d80?w=150&h=150&fit=crop&crop=face",
                    user_status: "Ho·∫°t ƒë·ªông 5 ph√∫t tr∆∞·ªõc",
                    message_text: "https://images.unsplash.com/photo-1470071459604-3b5ec3a7fe05?w=400&h=300&fit=crop",
                    sender: "other",
                    time_display: "15:45",
                    show_time: "TRUE",
                    message_type: "image"
                },
                {
                    screen_id: 2,
                    contact_name: "Mai Anh",
                    avatar_url: "https://images.unsplash.com/photo-1438761681033-6461ffad8d80?w=150&h=150&fit=crop&crop=face",
                    user_status: "Ho·∫°t ƒë·ªông 5 ph√∫t tr∆∞·ªõc",
                    message_text: "Oke b·∫°n!",
                    sender: "me",
                    time_display: "",
                    show_time: "FALSE",
                    message_type: "text"
                }
            ];

            const ws = XLSX.utils.json_to_sheet(sampleData);
            
            // Set column widths
            const colWidths = [
                { wch: 10 }, // screen_id
                { wch: 15 }, // contact_name
                { wch: 50 }, // avatar_url
                { wch: 20 }, // user_status
                { wch: 60 }, // message_text
                { wch: 8 },  // sender
                { wch: 18 }, // time_display
                { wch: 10 }, // show_time
                { wch: 12 }  // message_type
            ];
            ws['!cols'] = colWidths;
            
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Sample Data");
            
            // Generate file name with timestamp
            const timestamp = new Date().toISOString().slice(0, 10);
            const fileName = `messenger-sample-data-with-images-${timestamp}.xlsx`;
            
            XLSX.writeFile(wb, fileName);
            
            // Show success message
            setTimeout(() => {
                alert('‚úÖ ƒê√£ t·∫£i file Excel m·∫´u th√†nh c√¥ng!\n\nüìÅ File name: ' + fileName + '\nüìä D·ªØ li·ªáu: 2 m√†n h√¨nh, 8 tin nh·∫Øn (c√≥ c·∫£ text v√† image)\n\nüí° File n√†y ch·ª©a v√≠ d·ª• v·ªÅ c√°ch g·ª≠i ·∫£nh trong cu·ªôc tr√≤ chuy·ªán!');
            }, 100);
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            setTimeout(() => {
                successDiv.style.display = 'none';
            }, 5000);
        }
    </script>
</body>

</html>
